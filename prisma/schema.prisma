generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Package {
  package_id   String @id @default(uuid())
  package_key  String @unique
  package_name String

  owners     Owner[]
  categories HardwareCategory[]
  created_at DateTime           @default(now())

  @@map("packages")
}

model Owner {
  owner_id  String  @id @default(uuid())
  full_name String
  email     String  @unique
  phone     String  @unique
  password  String  @map("password_hash")
  fcm_token String?

  package_id String?
  package    Package? @relation(fields: [package_id], references: [package_id], onDelete: Restrict)

  suppliers HardwareSupplier[]

  products      HardwareProduct[]
  stockLots     HardwareStockLot[]
  stockOuts     HardwareStockOut[]
  otps          PasswordResetOtp[]
  stockOutItems HardwareStockOutItem[]
  notifications HardwareNotification[]

  customers               Customer[]
  clothingProducts        ClothingProduct[]
  clothingSuppliers       ClothingSupplier[]
  clothingSales           ClothingSales[]
  clothingCustomerReturns ClothingCustomerReturn[]
  clothingSupplierReturns ClothingSupplierReturn[]
  clothingNotifications ClothingNotification[]
  created_at              DateTime                 @default(now())
  updated_at              DateTime                 @updatedAt

  @@map("owners")
}

model PasswordResetOtp {
  id       String @id @default(uuid())
  owner_id String
  owner    Owner  @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)

  email      String
  otp_hash   String
  expires_at DateTime

  wrong_attempts Int       @default(0)
  locked_until   DateTime?
  last_sent_at   DateTime?
  verified_at    DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([owner_id])
  @@index([email])
  @@index([expires_at])
  @@map("password_reset_otps")
}

model HardwareSupplier {
  supplier_id String @id @default(uuid())
  owner_id    String
  owner       Owner  @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)

  supplier_name String
  phone         String
  email         String?
  address       String?

  stockLots HardwareStockLot[]

  created_at DateTime @default(now())

  // ✅ unique supplier phone per owner
  @@unique([owner_id, phone])
  @@map("hardware_suppliers")
}

model HardwareCategory {
  category_id String @id @default(uuid())

  package_id String
  package    Package @relation(fields: [package_id], references: [package_id], onDelete: Cascade)

  category_name String

  // who created (optional)

  products HardwareProduct[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // ✅ unique category name per package (shared)
  @@unique([package_id, category_name])
  @@map("hardware_categories")
}

model HardwareProduct {
  product_id String @id @default(uuid())
  owner_id   String
  owner      Owner  @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)

  category_id String
  category    HardwareCategory @relation(fields: [category_id], references: [category_id], onDelete: Restrict)

  product_name String

  stockLots     HardwareStockLot[]
  stockOutItems HardwareStockOutItem[]

  notifications HardwareNotification[]

  last_low_stock_notified_at DateTime?
  created_at                 DateTime  @default(now())
  updated_at                 DateTime  @updatedAt

  // ✅ product unique per owner (not package)
  @@unique([owner_id, product_name])
  @@map("hardware_products")
}

model HardwareStockLot {
  lot_id String @id @default(uuid())

  owner_id String
  owner    Owner  @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)

  product_id String
  product    HardwareProduct @relation(fields: [product_id], references: [product_id], onDelete: Cascade)

  supplier_id String
  supplier    HardwareSupplier @relation(fields: [supplier_id], references: [supplier_id], onDelete: Restrict)

  cp            Decimal @db.Decimal(10, 2)
  sp            Decimal @db.Decimal(10, 2)
  qty_in        Int
  qty_remaining Int
  notes         String?

  stockOutItems HardwareStockOutItem[]

  created_at DateTime @default(now())

  @@index([owner_id, product_id])
  @@index([owner_id, supplier_id])
  @@map("hardware_stock_lots")
}

model HardwareStockOut {
  stockout_id String @id @default(uuid())

  owner_id String
  owner    Owner  @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)

  customer_name       String?
  customer_phn_number String?
  customer_address    String?
  payment_status      String  @default("pending")
  total_amount        Decimal @db.Decimal(10, 2)
  paid_amount         Decimal @db.Decimal(10, 2)
  note                String?

  items HardwareStockOutItem[]

  created_at DateTime @default(now())

  @@index([owner_id])
  @@map("hardware_stock_out")
}

model HardwareStockOutItem {
  stockout_item_id String @id @default(uuid())

  owner_id String
  owner    Owner  @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)

  stockout_id String
  stockout    HardwareStockOut @relation(fields: [stockout_id], references: [stockout_id], onDelete: Cascade)

  product_id String
  product    HardwareProduct @relation(fields: [product_id], references: [product_id], onDelete: Restrict)

  lot_id String
  lot    HardwareStockLot @relation(fields: [lot_id], references: [lot_id], onDelete: Restrict)

  qty        Int
  cp         Decimal @db.Decimal(10, 2)
  sp         Decimal @db.Decimal(10, 2)
  note       String?
  line_total Decimal @db.Decimal(10, 2)

  created_at DateTime @default(now())

  @@index([owner_id, stockout_id])
  @@index([owner_id, product_id])
  @@index([owner_id, lot_id])
  @@map("hardware_stock_out_items")
}

model HardwareNotification {
  notification_id String @id @default(uuid())

  owner_id String
  owner    Owner  @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)

  type    String // e.g. LOW_STOCK
  title   String
  message String

  product_id String?
  product    HardwareProduct? @relation(fields: [product_id], references: [product_id], onDelete: SetNull)

  read_at    DateTime?
  created_at DateTime  @default(now())

  @@index([owner_id, created_at])
  @@index([owner_id, read_at])
  @@map("hardware_notifications")
}



model ClothingCategory {
  category_id   String @id @default(uuid())
  category_name String @unique

  products ClothingProduct[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("clothing_categories")
}

model ClothingSize {
  size_id   String @id @default(uuid())
  size_name String @unique

  stockLots  ClothingStockLot[]
  salesItems ClothingSalesItem[]

  @@map("clothing_sizes")
}

model ClothingColor {
  color_id   String @id @default(uuid())
  color_name String @unique

  stockLots  ClothingStockLot[]
  salesItems ClothingSalesItem[]

  @@map("clothing_colors")
}

model ClothingProduct {
  product_id String @id @default(uuid())

  owner_id String
  owner    Owner  @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)

  category_id String
  category    ClothingCategory @relation(fields: [category_id], references: [category_id], onDelete: Restrict)

  product_name String

  stockLots  ClothingStockLot[]
  salesItems ClothingSalesItem[]

  clothingNotifications ClothingNotification[]
  last_low_stock_notified_at DateTime?


  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([owner_id, product_name])
  @@index([owner_id, category_id])
  @@map("clothing_products")
}

model ClothingSupplier {
  supplier_id String @id @default(uuid())

  owner_id String
  owner    Owner  @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)

  supplier_name String
  phone         String
  email         String?
  address       String?

  stockLots ClothingStockLot[]

  created_at DateTime                 @default(now())
  returns    ClothingSupplierReturn[]

  @@unique([owner_id, phone])
  @@map("clothing_suppliers")
}

model ClothingStockLot {
  lot_id String @id @default(uuid())

  product_id String
  product    ClothingProduct @relation(fields: [product_id], references: [product_id], onDelete: Cascade)

  supplier_id String
  supplier    ClothingSupplier @relation(fields: [supplier_id], references: [supplier_id], onDelete: Restrict)

  size_id String
  size    ClothingSize @relation(fields: [size_id], references: [size_id], onDelete: Restrict)

  color_id String
  color    ClothingColor @relation(fields: [color_id], references: [color_id], onDelete: Restrict)

  cp            Decimal @db.Decimal(10, 2)
  sp            Decimal @db.Decimal(10, 2)
  qty_in        Int
  qty_remaining Int
  notes         String?

  salesItems          ClothingSalesItem[]
  customerReturnItems ClothingCustomerReturnItem[]
  supplierReturnItems ClothingSupplierReturnItem[]
  created_at          DateTime                     @default(now())

  @@index([product_id])
  @@index([supplier_id])
  @@index([product_id, size_id, color_id])
  @@map("clothing_stock_lots")
}

model ClothingSales {
  sales_id String @id @default(uuid())

  owner_id String
  owner    Owner  @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)

  customer_id String?
  customer    Customer? @relation(fields: [customer_id], references: [customer_id], onDelete: SetNull)

  payment_status String  @default("pending")
  total_amount   Decimal @db.Decimal(10, 2)
  paid_amount    Decimal @db.Decimal(10, 2)
  note           String?

  items           ClothingSalesItem[]
  customerReturns ClothingCustomerReturn[]
  created_at      DateTime                 @default(now())

  @@index([owner_id, created_at])
  @@index([customer_id])
  @@map("clothing_sales")
}

model ClothingSalesItem {
  sales_item_id String @id @default(uuid())

  sales_id String
  sales    ClothingSales @relation(fields: [sales_id], references: [sales_id], onDelete: Cascade)

  product_id String
  product    ClothingProduct @relation(fields: [product_id], references: [product_id], onDelete: Restrict)

  lot_id String
  lot    ClothingStockLot @relation(fields: [lot_id], references: [lot_id], onDelete: Restrict)

  size_id String
  size    ClothingSize @relation(fields: [size_id], references: [size_id], onDelete: Restrict)

  color_id String
  color    ClothingColor @relation(fields: [color_id], references: [color_id], onDelete: Restrict)

  qty        Int
  returned_qty  Int @default(0) 
  cp         Decimal @db.Decimal(10, 2)
  sp         Decimal @db.Decimal(10, 2)
  line_total Decimal @db.Decimal(10, 2)
  note       String?

  created_at          DateTime                     @default(now())
  customerReturnItems ClothingCustomerReturnItem[]

  @@index([sales_id])
  @@index([product_id])
  @@index([lot_id])
  @@map("clothing_sales_items")
}


model Customer {
  customer_id String @id @default(uuid())

  owner_id String
  owner    Owner  @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)

  full_name String
  phone     String?
  email     String?
  address   String?

  sales ClothingSales[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([owner_id, phone])
  @@index([owner_id])
  @@map("customers")
}

model ClothingCustomerReturn {
  return_id String @id @default(uuid())

  owner_id String
  owner    Owner  @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)

  sales_id String?
  sales    ClothingSales? @relation(fields: [sales_id], references: [sales_id], onDelete: SetNull)

  refund_amount Decimal? @db.Decimal(10, 2)
  note          String?

  items ClothingCustomerReturnItem[]

  created_at DateTime @default(now())

  @@index([owner_id, created_at])
  @@map("clothing_customer_returns")
}

model ClothingCustomerReturnItem {
  return_item_id String @id @default(uuid())

  return_id String
  return    ClothingCustomerReturn @relation(fields: [return_id], references: [return_id], onDelete: Cascade)

  sales_item_id String?
  salesItem     ClothingSalesItem? @relation(fields: [sales_item_id], references: [sales_item_id], onDelete: SetNull)

  lot_id String
  lot    ClothingStockLot @relation(fields: [lot_id], references: [lot_id], onDelete: Restrict)

  qty       Int
  condition String  @default("good") // good | damaged
  note      String?

  created_at DateTime @default(now())

  @@index([return_id])
  @@index([lot_id])
  @@map("clothing_customer_return_items")
}

model ClothingSupplierReturn {
  return_id String @id @default(uuid())

  owner_id String
  owner    Owner  @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)

  supplier_id String
  supplier    ClothingSupplier @relation(fields: [supplier_id], references: [supplier_id], onDelete: Restrict)

  status String  @default("pending") // pending | approved | completed
  note   String?

  items ClothingSupplierReturnItem[]

  created_at DateTime @default(now())

  @@index([owner_id, created_at])
  @@index([owner_id, supplier_id])
  @@map("clothing_supplier_returns")
}

model ClothingSupplierReturnItem {
  return_item_id String @id @default(uuid())

  return_id String
  return    ClothingSupplierReturn @relation(fields: [return_id], references: [return_id], onDelete: Cascade)

  lot_id String
  lot    ClothingStockLot @relation(fields: [lot_id], references: [lot_id], onDelete: Restrict)

  qty    Int
  reason String? // damaged | wrong | expired etc.
  note   String?

  created_at DateTime @default(now())

  @@index([return_id])
  @@index([lot_id])
  @@map("clothing_supplier_return_items")
}
model ClothingNotification {
  notification_id String @id @default(uuid())

  owner_id String
  owner    Owner @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)

  type    String // e.g. LOW_STOCK
  title   String
  message String

  product_id String?
  product    ClothingProduct? @relation(fields: [product_id], references: [product_id], onDelete: SetNull)

  read_at    DateTime?
  created_at DateTime @default(now())

  @@index([owner_id, created_at])
  @@index([owner_id, read_at])
  @@map("clothing_notifications")
}
